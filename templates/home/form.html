{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}

  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header card-header-primary">
          <h4 class="card-title">Formulario del paciente</h4>
          <p class="card-category">{% if patient %}{{ patient.nombre }} {{ patient.apellidos }} - {{ patient.cedula }}{% else %}Nuevo paciente{% endif %}</p>
        </div>
        <div class="card-body main-card position-relative">

          <div id="test-detail-container" class="help-text test-help-text d-none">
            <div class="help-content">
              <h5></h5>
              <p></p>
            </div>
          </div>


          <div class="d-flex justify-content-center">


            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-demograficos-tab" data-bs-toggle="pill" data-bs-target="#pills-demograficos" type="button" role="tab" aria-controls="pills-demograficos" aria-selected="true">Datos demográficos</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-acompanante-tab" data-bs-toggle="pill" data-bs-target="#pills-acompanante" type="button" role="tab" aria-controls="pills-acompanante" aria-selected="false">Acompañante</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-habitos-tab" data-bs-toggle="pill" data-bs-target="#pills-habitos" type="button" role="tab" aria-controls="pills-habitos" aria-selected="false">Hábitos</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-clinica-tab" data-bs-toggle="pill" data-bs-target="#pills-clinica" type="button" role="tab" aria-controls="pills-clinica" aria-selected="false">Historia clínica</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-archivos-tab" data-bs-toggle="pill" data-bs-target="#pills-archivos" type="button" role="tab" aria-controls="pills-archivos" aria-selected="false">Documentos</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-diagnostico-tab" data-bs-toggle="pill" data-bs-target="#pills-diagnostico" type="button" role="tab" aria-controls="pills-diagnostico" aria-selected="false">Diagnósticos</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-evolucion-tab" data-bs-toggle="pill" data-bs-target="#pills-evolucion" type="button" role="tab" aria-controls="pills-evolucion" aria-selected="false">Evolución</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-test-tab" data-bs-toggle="pill" data-bs-target="#pills-test" type="button" role="tab" aria-controls="pills-test" aria-selected="false">Tests</button>
              </li>
            </ul>
          </div>

          <form id="main-form" action="" method="post" enctype="multipart/form-data" class="mb-5">
            {% csrf_token %}

            <div class="tab-content" id="pills-tabContent">
              <div class="tab-pane fade show active" id="pills-demograficos" role="tabpanel" aria-labelledby="pills-demograficos-tab" tabindex="0">
                
                <div class="form-section-container">
                  
                  <div class="row">

                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.cedula.id_for_label }}>{{ patient_form.cedula.label }}</label>
                        {{ patient_form.cedula }}
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.nombre.id_for_label }}>{{ patient_form.nombre.label }}</label>
                        {{ patient_form.nombre }}
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.apellidos.id_for_label }}>{{ patient_form.apellidos.label }}</label>
                        {{ patient_form.apellidos }}
                      </div>
                    </div>
      
                  </div>
      
      
                  <div class="row">
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.fecha_nacimiento.id_for_label }}>{{ patient_form.fecha_nacimiento.label }}</label>
                        <input type="date" name="fecha_nacimiento" id="id_fecha_nacimiento" class="django-patient-form" required value={{ patient_form.fecha_nacimiento.value|date:"Y-m-d" }}>
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.telefono.id_for_label }}>{{ patient_form.telefono.label }}</label>
                        {{ patient_form.telefono }}
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.email.id_for_label }}>{{ patient_form.email.label }}</label>
                        {{ patient_form.email }}
                      </div>
                    </div>
      
                  </div>

      
                  <div class="row">
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.ocupacion.id_for_label }}>{{ patient_form.ocupacion.label }}</label>
                        {{ patient_form.ocupacion }}
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.profesion.id_for_label }}>{{ patient_form.profesion.label }}</label>
                        {{ patient_form.profesion }}
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.seguridad_social.id_for_label }}>{{ patient_form.seguridad_social.label }}</label>
                        {{ patient_form.seguridad_social }}
                      </div>
                    </div>
      
                  </div>

                </div>

              </div>
              <div class="tab-pane fade" id="pills-acompanante" role="tabpanel" aria-labelledby="pills-acompanante-tab" tabindex="0">
                
                <div class="form-section-container">

                  <div class="row">
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.acompanante.id_for_label }}>{{ patient_form.acompanante.label }}</label>
                        {{ patient_form.acompanante }}
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.parentesco.id_for_label }}>{{ patient_form.parentesco.label }}</label>
                        {{ patient_form.parentesco }}
                      </div>
                    </div>
      
                    <div class="col-md-4">
                      <div class="form-field">
                        <label for={{ patient_form.telefono_acompanante.id_for_label }}>{{ patient_form.telefono_acompanante.label }}</label>
                        {{ patient_form.telefono_acompanante }}
                      </div>
                    </div>
      
                  </div>

                </div>

              </div>
              <div class="tab-pane fade" id="pills-habitos" role="tabpanel" aria-labelledby="pills-habitos-tab" tabindex="0">
                
                <div class="form-section-container">

                  <div class="row">

                    <div class="col-md-2">
                      <div class="form-field">
                        <label for={{ patient_form.actividad_fisica.id_for_label }}>{{ patient_form.actividad_fisica.label }}</label>
                        {{ patient_form.actividad_fisica }}
                      </div>
                    </div>
      
                    <div class="col-md-5">
                      <div class="form-field">
                        <label for={{ patient_form.tipo_actividad_fisica.id_for_label }}>{{ patient_form.tipo_actividad_fisica.label }}</label>
                        {{ patient_form.tipo_actividad_fisica }}
                      </div>
                    </div>
      
                    <div class="col-md-5">
                      <div class="form-field">
                        <label for={{ patient_form.frecuencia_actividad_fisica.id_for_label }}>{{ patient_form.frecuencia_actividad_fisica.label }}</label>
                        {{ patient_form.frecuencia_actividad_fisica }}
                      </div>
                    </div>
      
                  </div>
                
                </div>

              </div>
              <div class="tab-pane fade" id="pills-clinica" role="tabpanel" aria-labelledby="pills-clinica-tab" tabindex="0">
                
                <div class="form-section-container">

                  <div class="row">

                    <div class="col-md-6">
                      <div class="form-field">
                        <label for={{ patient_form.motivo_consulta.id_for_label }}>{{ patient_form.motivo_consulta.label }}</label>
                        {{ patient_form.motivo_consulta }}
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="form-field">
                        <label for={{ patient_form.cronologia_de_patologia.id_for_label }}>{{ patient_form.cronologia_de_patologia.label }}</label>
                        {{ patient_form.cronologia_de_patologia }}
                      </div>
                    </div>

                  </div>

                  <div class="row">
              
                    <div class="col-md-6">
                      <div class="form-field">
                        <label for={{ patient_form.conclusion.id_for_label }}>{{ patient_form.conclusion.label }}</label>
                        {{ patient_form.conclusion }}
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label for={{ patient_form.documento_adjunto.id_for_label }} for={{ patient_form.documento_adjunto.id_for_label }}>{{ patient_form.documento_adjunto.label }}</label>
                      {{ patient_form.documento_adjunto }}
                    </div>

                  </div>
                
                </div>

              </div>
              <div class="tab-pane fade" id="pills-archivos" role="tabpanel" aria-labelledby="pills-archivos-tab" tabindex="0">

                <div class="form-section-container">

                  <div id="document-home-page">

                    <div class="row">

                      <div class="col-md-12">

                        <div class="accordion" id="accordionDocument">
                          {% for file in patient_attached_files %}
                          <div class="accordion-item">
                            <h2 class="accordion-header">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-file-{{ forloop.counter }}" aria-expanded="true" aria-controls="collapseOne">
                                {{ file.created_at }}
                              </button>
                            </h2>
                            <div id="collapse-file-{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                              <div class="accordion-body">
                                <a href={{ MEDIA_URL }}{{ file.file }}>{{ file.name }}</a>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      
                      </div>
                      
                    </div>

                    <div class="row">

                      <div class="col-md-12">
  
                        <button id="document-form-displayer" class="w-100 add-accordion-field-button">
                          Agregar documento
                        </button>
  
                      </div>
  
                    </div>

                  </div>

                  <div id="document-form-page" class="d-none">
                    
                    <div class="row">

                      <div class="col-md-2">
                      </div>

                      <div class="col-md-8">

                        <div class="row">
                          <div class="col-md-12 d-flex justify-content-center">
                            <label for={{ attached_file_form.file.id_for_label }}>{{ attached_file_form.file.label }}</label>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-12 d-flex">

                            {{ attached_file_form.file }}
                            {% if patient %}
                            <input type="hidden" name="patient" value={{ patient.pk }}>
                            {% endif %}
                          </div>
                        </div>
                        
                        <div class="row">

                          <div class="col-md-12 d-flex justify-content-center mt-3">
                            <button id="document-form-hider" class="abort-accordion-field-button secondary">
                              No agregar
                            </button>
                          </div>

                        </div>

                      </div>

                      <div class="col-md-2">
                      </div>

                    </div>

                  </div>

                </div>  

              </div>
              <div class="tab-pane fade" id="pills-diagnostico" role="tabpanel" aria-labelledby="pills-diagnostico-tab" tabindex="0">

                <div class="form-section-container">

                  <div id="diagnosis-home-page">

                    <div class="row">

                      <div class="col-md-12">
  
                        <div class="accordion" id="accordionDiagnostico">
                          {% for patient_diagnosis in patient_diagnoses %}
                          <div class="accordion-item">
                            <h2 class="accordion-header">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-patient-diagnosis{{ forloop.counter }}" aria-expanded="true" aria-controls="collapseOne">
                                {{ patient_diagnosis.created_at }}
                              </button>
                            </h2>
                            <div id="collapse-patient-diagnosis{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                              <div class="accordion-body">
                                <strong>{{ patient_diagnosis.diagnosis.diagnosis_code }}</strong> 
                                {{ patient_diagnosis.diagnosis.diagnosis_description }}
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      
                      </div>
                      
                    </div>

                    <div class="row">

                      <div class="col-md-12">
  
                        <button id="patient-diagnosis-form-displayer" class="w-100 add-accordion-field-button">
                          Agregar diagnóstico
                        </button>
  
                      </div>
  
                    </div>

                  </div>

                  <div id="patient-diagnosis-form-page" class="d-none">
                    
                    <div class="row">

                      <div class="col-md-2">
                      </div>

                      <div class="col-md-8">

                        <div class="row">
                          <div class="col-md-12">

                            <label for={{ patient_diagnosis_form.diagnosis.id_for_label }}>{{ patient_diagnosis_form.diagnosis.label }}</label>
                            <div class="d-none">
                              {{ patient_diagnosis_form.diagnosis }}
                            </div>
                          
                          </div>
                        </div>
                        
                        <div class="row">

                          <div class="col-md-12">
                            <div id="select-diagnosis" class="select-diagnosis">
                              <button id="diagnosis-select">
                                <div>Seleccionar</div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="15.6" height="15.6" viewBox="0 0 24 24">
                                  <path d="M12 17.414L3.293 8.707l1.414-1.414L12 14.586l7.293-7.293 1.414 1.414L12 17.414z"/>
                                </svg>
                              </button>
                            </div>
                          </div>

                          <div class="col-md-12 d-flex justify-content-center mt-3">
                            <button id="patient-diagnosis-form-hider" class="abort-accordion-field-button secondary">
                              No agregar
                            </button>
                          </div>

                        </div>

                        <div class="row diagnosis-search-box">
                          <div class="col-md-12">
                            <div class="select-search-wrapper">
                              <div id="diagnosis-search-container" class="search-container">
                                <div class="search-input-header">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                  </svg>
                                  <input id="diagnosis-search-input" class="search-input" type="search" placeholder="Buscar...">
                                </div>
                                
                                <div class="option-container">
                                  <ul>
                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                      </div>

                      <div class="col-md-2">
                      </div>

                    </div>

                  </div>

                </div>  

              </div>
              <div class="tab-pane fade" id="pills-evolucion" role="tabpanel" aria-labelledby="pills-evolucion-tab" tabindex="0">
                
                <div class="form-section-container">

                  <div id="evolution-home-page">

                    <div class="row">

                      <div class="col-md-12">
  
                        <div class="accordion" id="accordionEvolucion">
                          {% for record in evolution_records %}
                          <div class="accordion-item">
                            <h2 class="accordion-header">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-evolucion-{{ forloop.counter }}" aria-expanded="true" aria-controls="collapseOne">
                                {{ record.created_at }}
                              </button>
                            </h2>
                            <div id="collapse-evolucion-{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                              <div class="accordion-body">
                                {{ record.evolution_record }}
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      
                      </div>
                      
                    </div>

                    <div class="row">

                      <div class="col-md-12">
  
                        <button id="evolution-form-displayer" class="w-100 add-accordion-field-button">
                          Agregar registro
                        </button>
  
                      </div>
  
                    </div>

                  </div>

                  <div id="evolution-form-page" class="d-none">


                    <div class="row">

                      <div class="col-md-2"></div>

                      <div class="col-md-8">

                        <div class="row">

                          <div class="col-md-12">
                            <div class="form-field">
                              <label for={{ evolution_form.evolution_record.id_for_label }}>{{ evolution_form.evolution_record.label }}</label>
                              {{ evolution_form.evolution_record }}
                            </div>
                          </div>
  
  
                          <div class="col-md-12 d-flex justify-content-center mt-3">
                            <button id="evolution-form-hider" class="abort-accordion-field-button secondary">
                              No agregar
                            </button>
                          </div>
  
  
                        </div>

                      </div>

                      <div class="col-md-2"></div>

                    </div>

                  </div>

                </div>

              </div>
              <div class="tab-pane fade" id="pills-test" role="tabpanel" aria-labelledby="pills-test-tab" tabindex="0">

                <div class="form-section-container">

                  <div id="test-home-page">

                    <div class="row">
  
                      <div class="col-md-12">
  
                        <div class="accordion" id="accordionTest">
                          {% for patient_test in patient_tests %}
                          <div class="accordion-item">
                            <h2 class="accordion-header">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-test-{{ forloop.counter }}" aria-expanded="true" aria-controls="collapseOne">
                                {{ patient_test.test }}
                              </button>
                            </h2>
                            <div id="collapse-test-{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                              <div class="accordion-body">
                                {{ patient_test.result }}
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
  
                      </div>
  
                    </div>
  
                    <div class="row">
                      <div class="col-md-12">
                        <button id="patient-test-form-displayer" class="w-100 add-accordion-field-button">
                          Agregar test
                        </button>
                      </div>
                    </div>
  
                  </div>
  
                  <div id="patient-test-form-page" class="d-none">
  
                    <div class="row">

                      <div class="col-md-2"></div>

                      <div class="col-md-8 position-relative">

                        <div class="row">
  
                          <div class="col-md-12">

                            <label for={{ patient_test_form.test.id_for_label }}>{{ patient_test_form.test.label }}</label>
                            <div class="d-none">
                              {{ patient_test_form.test }}
                            </div>
  
                          </div>
  
                        </div>

                        <div class="row">
                          <div class="col-md-12">
                            <div id="select-test" class="select-diagnosis">
                              <button id="test-select">
                                <div>Seleccionar</div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="15.6" height="15.6" viewBox="0 0 24 24">
                                  <path d="M12 17.414L3.293 8.707l1.414-1.414L12 14.586l7.293-7.293 1.414 1.414L12 17.414z"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>

                        <div class="row diagnosis-search-box">
                          <div class="col-md-12">
                            <div class="select-search-wrapper">
                              <div id="test-search-container" class="search-container">
                                <div class="option-container test-option-container">
                                  <ul>
                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row mt-3 test-form-secondary">

                          <div class="col-md-12">

                            <div class="form-field">
                              <label for={{ patient_test_form.result.id_for_label }}>{{ patient_test_form.result.label }}</label>
                              {{ patient_test_form.result }}
                            </div>

                          </div>

                        </div>

                        <div class="row test-form-secondary">

                          <div class="col-md-12 d-flex justify-content-center mt-3">
                            <button id="patient-test-form-hider" class="abort-accordion-field-button secondary">
                              No agregar
                            </button>
                          </div>

                        </div>

                      </div>

                      <div class="col-md-2"></div>
                      
                    </div>
  
                  </div>
  
                  {% comment %} <div id="test-form-page" class="d-none">
  
                    <div class="card fetch-form">

                      <div class="card-header card-header-primary">
                        <h4 class="card-title">
                          Nuevo test
                        </h4>
                      </div>
                      <div class="card-body">

                        <div class="row">
  
                          <div class="col-md-4">
      
                            <div class="form-field">
                              <label for={{ test_form.test_name.id_for_label }}>{{ test_form.test_name.label }}</label>
                              {{ test_form.test_name }}
                            </div>
      
                          </div>
      
                          <div class="col-md-8">
      
                            <div class="form-field">
                              <label for={{ test_form.test_description.id_for_label }}>{{ test_form.test_description.label }}</label>
                              {{ test_form.test_description }}
                            </div>
      
                          </div>
      
                        </div>
      
                        <div class="row">
      
                          <div class="col-md-4">
      
                            <div class="form-field">
                              <label for={{ test_form.category.id_for_label }}>{{ test_form.category.label }}</label>
                              {{ test_form.category }}
                            </div>
      
                          </div>
      
                          <div class="col-md-4">
      
                            <div class="form-field">
                              <label for={{ test_form.subcategory.id_for_label }}>{{ test_form.subcategory.label }}</label>
                              {{ test_form.subcategory }}
                            </div>
      
                          </div>
      
                          <div class="col-md-4">
      
                            <div class="form-field">
                              <label for={{ test_form.result_type.id_for_label }}>{{ test_form.result_type.label }}</label>
                              {{ test_form.result_type }}
                            </div>
      
                          </div>
                          
                        </div>

                        <div class="row">

                          <div class="col-md-12 d-flex justify-content-center mt-3">

                            <button id="test-form-hider" class="fetch-control-button secondary">
                              Cancelar
                            </button>

                            <button id="test-form-submitter" class="fetch-control-button primary">
                              Guardar
                            </button>

                          </div>
                          
                        </div>

                      </div>
                    
                    </div>
  
                  </div> {% endcomment %}

                </div>
                
              </div>
            </div>

            
            <button id="patient-form-submitter" type="submit" class="submitting-button btn btn-primary pull-right">Guardar</button>
            <div class="clearfix"></div>
          </form>
          
        </div>

        {% if patient %}

        <!-- Button trigger modal -->
        <button type="button" class="btn btn-outline-danger delete-button pull-left" data-toggle="modal" data-target="#exampleModalCenter">
          Eliminar
        </button>

        <!-- Modal -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">¿Eliminar paciente?</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                Confirma que quieres eliminar al paciente.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button id="patient-deleter" type="button" class="btn delete-button confirmation-button">Eliminar</button>
              </div>
            </div>
          </div>
        </div>

        {% endif %}

      </div>
    </div>
  </div>
  
{% endblock content %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<!-- Page specific JavaScript -->
{{ js_variables|json_script:'js-variables' }}
<script type="text/javascript" src={% static 'assets/js/form.js' %}></script>
{% endblock javascripts %}